name: Build Preview APK

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch: # Allows manual trigger from GitHub Actions tab

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.24.0

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Expo prebuild for Android
        run: pnpm expo prebuild --platform android --clean

      - name: Create keystore directory
        run: mkdir -p android/app/keystore

      - name: Generate debug keystore
        run: |
          keytool -genkeypair -v -storetype PKCS12 \
            -keystore android/app/keystore/debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Build APK
        working-directory: ./android
        run: ./gradlew assembleRelease --no-daemon

      - name: Find and rename APK
        id: find-apk
        run: |
          # Find the APK file
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" | head -n 1)
          echo "Original APK: $APK_PATH"
          
          # Get commit short SHA
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # Create new filename with timestamp and commit
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          NEW_NAME="0xbasinasnews-${TIMESTAMP}-${SHORT_SHA}.apk"
          NEW_PATH="$(dirname $APK_PATH)/${NEW_NAME}"
          
          # Rename the APK
          mv "$APK_PATH" "$NEW_PATH"
          
          echo "apk_path=$NEW_PATH" >> $GITHUB_OUTPUT
          echo "apk_name=$NEW_NAME" >> $GITHUB_OUTPUT

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-preview-apk
          path: ${{ steps.find-apk.outputs.apk_path }}
          retention-days: 30

      - name: Create Release Notes
        run: |
          cat > release-notes.txt << EOF
          ðŸ“± Android Preview APK Build
          
          Build Information:
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref_name }}
          - Build Date: $(date)
          - Package: com.basinasnews.cybersecurity
          
          Download the APK from the artifacts section above.
          EOF

      - name: Upload Release Notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.txt
          retention-days: 30

      - name: Build Summary
        run: |
          echo "### âœ… APK Build Successful! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**APK Name:** ${{ steps.find-apk.outputs.apk_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download:** Check the 'Artifacts' section at the top of this workflow run." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ The APK is available for download for 30 days." >> $GITHUB_STEP_SUMMARY
