name: Android Preview APK

on:
  workflow_dispatch:
    inputs:
      buildType:
        description: Gradle build type (Debug or Release)
        required: true
        default: Debug
  push:
    branches:
      - main
      - develop
      - feature/**
  pull_request:
    branches:
      - main
      - develop

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      EXPO_NO_TELEMETRY: "1"
      CI: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Node setup (avoid "cache: pnpm" here; we cache pnpm store separately)
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # pnpm setup if repo uses it
      - name: Setup pnpm
        if: ${{ hashFiles('**/pnpm-lock.yaml') != '' }}
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Cache pnpm store
        if: ${{ hashFiles('**/pnpm-lock.yaml') != '' }}
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-

      # Dependency installs (auto-detect pkg manager)
      - name: Install dependencies (pnpm)
        if: ${{ hashFiles('**/pnpm-lock.yaml') != '' }}
        run: pnpm install --frozen-lockfile

      - name: Install dependencies (yarn)
        if: ${{ hashFiles('**/yarn.lock') != '' && hashFiles('**/pnpm-lock.yaml') == '' }}
        run: yarn install --frozen-lockfile

      - name: Install dependencies (npm)
        if: ${{ hashFiles('**/package-lock.json') != '' && hashFiles('**/pnpm-lock.yaml') == '' && hashFiles('**/yarn.lock') == '' }}
        run: npm ci

      # Java + Android SDK
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android licenses
        run: yes | sdkmanager --licenses

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # Ensure native project exists and synced with app config
      - name: Ensure android/ exists (expo prebuild)
        run: |
          if [ ! -d "android" ]; then
            npx --yes expo prebuild --platform android --no-install --clean
          fi

      - name: Sync native code (expo prebuild update)
        run: npx --yes expo prebuild --platform android --no-install

      - name: Gradle wrapper permissions
        run: chmod +x android/gradlew

      - name: Build APK
        working-directory: android
        env:
          ORG_GRADLE_PROJECT_org.gradle.jvmargs: "-Xmx4g -Dfile.encoding=UTF-8"
        run: |
          BUILD_TYPE="${{ github.event.inputs.buildType || 'Debug' }}"
          if [ "$BUILD_TYPE" = "Release" ]; then
            ./gradlew assembleRelease --stacktrace
          else
            ./gradlew assembleDebug --stacktrace
          fi

      - name: Locate APK
        id: find_apk
        run: |
          BUILD_TYPE="${{ github.event.inputs.buildType || 'Debug' }}"
          if [ "$BUILD_TYPE" = "Release" ]; then
            PATTERN="android/app/build/outputs/apk/release/*.apk"
          else
            PATTERN="android/app/build/outputs/apk/debug/*.apk"
          fi
          FILE=$(ls -1 $PATTERN | head -n 1)
          if [ -z "$FILE" ]; then
            echo "APK not found" && exit 1
          fi
          echo "apk_path=$FILE" >> $GITHUB_OUTPUT
          echo "Found: $FILE"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-preview-${{ github.event.inputs.buildType || 'Debug' }}
          path: ${{ steps.find_apk.outputs.apk_path }}
          if-no-files-found: error
          compression-level: 9
